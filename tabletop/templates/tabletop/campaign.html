<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaign</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
    <script>
        const campaignId = {{ campaign_id }};
        const socket = new WebSocket(`ws://${window.location.host}/ws/tabletop/${campaignId}/`);

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.action === 'load_map') {
                loadMap(data.map_id);
            } else if (data.action === 'move_token') {
                moveToken(data.token_id, data.position_x, data.position_y);
            }
        };

        function loadMap(mapId) {
            $.get(`/tabletop/map/${mapId}/`, function(data) {
                $('#map-container').html(data);
                initializeDraggableTokens();
            });
        }

        function selectMap(mapId) {
            socket.send(JSON.stringify({
                'action': 'load_map',
                'map_id': mapId
            }));
        }

        function initializeDraggableTokens() {
            $(".token").draggable({
                containment: "#map img",  // Restringe o movimento ao tamanho da imagem do mapa
                drag: function(event, ui) {
                    var tokenId = $(this).data("id");
                    var position = ui.position;
        
                    // Arredonda as posições para valores inteiros
                    var positionX = Math.round(position.left);
                    var positionY = Math.round(position.top);
        
                    // Atualiza a posição do token em tempo real
                    socket.send(JSON.stringify({
                        'action': 'move_token',
                        'token_id': tokenId,
                        'position_x': positionX,
                        'position_y': positionY
                    }));
                },
                stop: function(event, ui) {
                    var tokenId = $(this).data("id");
                    var position = ui.position;
        
                    // Arredonda as posições para valores inteiros
                    var positionX = Math.round(position.left);
                    var positionY = Math.round(position.top);
        
                    // Envia a posição final do token ao servidor
                    $.ajax({
                        url: `/tabletop/token/${tokenId}/move/`,
                        method: 'POST',
                        data: {
                            'position_x': positionX,
                            'position_y': positionY,
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        success: function() {
                            // Envia a atualização final via WebSocket
                            socket.send(JSON.stringify({
                                'action': 'move_token',
                                'token_id': tokenId,
                                'position_x': positionX,
                                'position_y': positionY
                            }));
                        }
                    });
                }
            });
        }

        function moveToken(tokenId, positionX, positionY) {
            const token = $(`.token[data-id=${tokenId}]`);
            token.css({ left: `${positionX}px`, top: `${positionY}px` });
        }

        $(document).ready(function() {
            initializeDraggableTokens();
        });
    </script>
</head>
<body>
    <h1>Campaign Maps</h1>
    <ul>
        {% for map in maps %}
            <li><a href="#" onclick="selectMap({{ map.id }})">{{ map.name }}</a></li>
        {% endfor %}
    </ul>
    <div id="map-container">
        <!-- Loaded map will be inserted here -->
    </div>
</body>
</html>
