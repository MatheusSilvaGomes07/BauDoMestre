{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaign</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="{% static "css/tabletop.css" %}">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        let currentMapId = null; // Vari√°vel global para armazenar o ID do mapa
        const campaignId = {{ campaign_id }};
        const socket = new WebSocket(`ws://${window.location.host}/ws/tabletop/${campaignId}/`);
        let selectedTokenId = null;

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
        
            if (data.action === 'load_map') {
                loadMap(data.map_id);
            } else if (data.action === 'move_token') {
                moveToken(data.token_id, data.position_x, data.position_y);
            } else if (data.action === 'delete_token' && data.hide) {
                const tokenElement = document.querySelector(`.token[data-id="${data.token_id}"]`);
                if (tokenElement) {
                    tokenElement.remove();
                    updateTokenPositions();
                }
            } else if (data.action === 'place_token') {
                const tokenId = data.token_id;
                const positionX = data.position_x;
                const positionY = data.position_y;
                const imageUrl = data.image;
            
                // Crie um novo div para o token
                const tokenElement = document.createElement('div');
                tokenElement.classList.add('token'); 
                tokenElement.classList.add('ui-draggable');
                tokenElement.classList.add('ui-draggable-handle');// Adiciona a classe 'token'
                tokenElement.setAttribute('data-id', tokenId); // Define o ID do token como atributo data-id
                tokenElement.style.position = 'absolute'; // Define a posi√ß√£o como absoluta
                tokenElement.style.left = `${positionX}px`; // Define a posi√ß√£o X
                tokenElement.style.top = `${positionY}px`; // Define a posi√ß√£o Y
                tokenElement.style.width = '68px'; // Define a largura do token
                tokenElement.style.height = '68px'; // Define a altura do token
            
                // Crie o elemento de imagem dentro do tokenElement
                const imgElement = document.createElement('img');
                imgElement.src = imageUrl; // Define a URL da imagem
                imgElement.alt = 'Token'; // Adiciona texto alternativo para acessibilidade
                imgElement.style.width = '100%'; // Faz a imagem ocupar toda a largura do div
                imgElement.style.height = '100%'; // Faz a imagem ocupar toda a altura do div
                imgElement.style.cursor = 'pointer'; // Define o cursor como pointer
            
                // Adiciona a imagem ao div do token
                tokenElement.appendChild(imgElement);
            
                // Adiciona o tokenElement ao cont√™iner de tokens
                document.getElementById('tokens').appendChild(tokenElement); // Substitua pelo ID do seu cont√™iner de tokens

                initializeDraggableTokens();
            }
        };

        function updateTokenPositions() {
            $(".token").each(function(index) {
                const tokenId = $(this).data("id");
                const positionX = $(this).position().left;
                const positionY = $(this).position().top;
        
                socket.send(JSON.stringify({
                    'action': 'move_token',
                    'token_id': tokenId,
                    'position_x': Math.round(positionX),
                    'position_y': Math.round(positionY)
                }));
            });
        }

        
        function loadMap(mapId) {
            $.get(`/tabletop/map/${mapId}/`, function(data) {
                $('#map-container').html(data);
                currentMapId = mapId;
                initializeDraggableTokens();
            });
        }
    
        function selectMap(mapId) {
            socket.send(JSON.stringify({
                'action': 'load_map',
                'map_id': mapId
            }));
        }
    
        function initializeDraggableTokens() {
            $(".token").draggable({
                containment: "#map img",
                drag: function(event, ui) {
                    const tokenId = $(this).data("id");
                    const position = ui.position;
    
                    const positionX = Math.round(position.left);
                    const positionY = Math.round(position.top);
    
                    socket.send(JSON.stringify({
                        'action': 'move_token',
                        'token_id': tokenId,
                        'position_x': positionX,
                        'position_y': positionY
                    }));
                },
                stop: function(event, ui) {
                    const tokenId = $(this).data("id");
                    const position = ui.position;
    
                    const positionX = Math.round(position.left);
                    const positionY = Math.round(position.top);
    
                    $.ajax({
                        url: `/tabletop/token/${tokenId}/move/`,
                        method: 'POST',
                        data: {
                            'position_x': positionX,
                            'position_y': positionY,
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        success: function() {
                            socket.send(JSON.stringify({
                                'action': 'move_token',
                                'token_id': tokenId,
                                'position_x': positionX,
                                'position_y': positionY
                            }));
                        }
                    });
                }
            });
        }

        function moveToken(tokenId, positionX, positionY) {
            const token = $(`.token[data-id=${tokenId}]`);
            token.css({ left: `${positionX}px`, top: `${positionY}px` });
        }

        // Sele√ß√£o e desele√ß√£o dos tokens
        $(document).on('click', '.token', function(e) {
            e.stopPropagation(); // Impede que o evento clique se propague para o documento
            const clickedTokenId = $(this).data('id');
            
            if (selectedTokenId !== clickedTokenId) {
                // Remove a borda do token selecionado anteriormente
                $(".token").removeClass("selected-token");

                // Adiciona a borda ao token atual
                $(this).addClass("selected-token");
                selectedTokenId = clickedTokenId;
            } else {
                // Se j√° est√° selecionado, remove a borda
                $(this).removeClass("selected-token");
                selectedTokenId = null;
            }
        });

        // Remove a borda ao clicar fora de qualquer token
        $(document).on('click', function() {
            $(".token").removeClass("selected-token");
            selectedTokenId = null;
        });

        $(document).ready(function() {
            initializeDraggableTokens();
        });
        
    </script>

</head>
<body>
    <div class="main-container">
        <!-- Div esquerda com imagem centralizada -->
        <div class="left" id="map-container">

        </div>
    
        <!-- Div direita com navbar e campo de cria√ß√£o de pasta -->
        <div class="right">
          <!-- Navbar no topo com dois √≠cones -->
          <div class="navbar">
            <div class="icon">üîç</div>
            <div class="icon">‚öôÔ∏è</div>
          </div>
    
          <!-- Input para criar pasta -->
          <div class="create-folder">
            {% include "tabletop/includes/pastaCriaturas.html" %}
          </div>
    
          <!-- Lista de pastas expans√≠veis com scroll -->
          <div class="folder-list">

            {% include "tabletop/includes/lista_pastasCriaturas.html" %}

          </div>
        </div>
      </div>
   
    {% if is_mestre %}
    <!-- Bot√£o de abrir modal lateral -->
    <button id="openModalBtn">Abrir Modal</button>

    <!-- Modal lateral -->
    <div id="sideModal">
        <button id="closeModalBtn">&times;</button> <!-- Bot√£o de fechar em forma de "X" -->

        <!-- Lista de imagens -->
        <div class="image-list">
            <!-- Card de criar o mapa- -->
            <div class="image-item" onclick="openModal()">
                <img src="https://via.placeholder.com/200x200/FFFFFF/FFFFFF?text=" alt="Imagem 1">
                <div class="image-name">Criar mapa</div>
                <div class="add-icon">+</div>
            </div>

            <!-- Modal criar mapa -->
            <div id="createMapModal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeModal()">&times;</span>
                    <h2>Criar Mapa</h2>
                    {% include "tabletop/includes/mapa_form.html" %}
                </div>
            </div>
            {% include "tabletop/includes/lista_mapas.html" %}

<!--
        <div class="image-item">
            <img src="https://via.placeholder.com/150" alt="Imagem 1">
            <div class="image-name">Imagem 1</div>
        </div>
        <div class="image-item">
            <img src="https://via.placeholder.com/150" alt="Imagem 2">
            <div class="image-name">Imagem 2</div>
        </div>
        <div class="image-item">
            <img src="https://via.placeholder.com/150" alt="Imagem 3">
            <div class="image-name">Imagem 3</div>
        </div>
        <div class="image-item">
            <img src="https://via.placeholder.com/150" alt="Imagem 4">
            <div class="image-name">Imagem 4</div>
        </div>
        <div class="image-item">
            <img src="https://via.placeholder.com/150" alt="Imagem 5">
            <div class="image-name">Imagem 5</div>
        </div>
-->
        </div>
    </div>

    <!-- Fundo esmaecido -->
    <div id="overlay"></div>

  {% endif %}

  <script>
    // Fun√ß√£o para alternar o conte√∫do da pasta
    function toggleFolderContent(element) {
      const content = element.nextElementSibling;
      const arrow = element.querySelector('.arrow');
      content.classList.toggle('active');
      arrow.style.transform = content.classList.contains('active') ? 'rotate(315deg)' : 'rotate(222deg)';
    }

    // Fun√ß√£o para abrir a modal lateral
    const openModalBtn = document.getElementById('openModalBtn');
    const sideModal = document.getElementById('sideModal');
    const overlay = document.getElementById('overlay');
    const closeModalBtn = document.getElementById('closeModalBtn');

    openModalBtn.addEventListener('click', () => {
      sideModal.classList.add('active');
      overlay.classList.add('active');
      openModalBtn.classList.add('active');
    });

    closeModalBtn.addEventListener('click', () => {
      sideModal.classList.remove('active');
      overlay.classList.remove('active');
      openModalBtn.classList.remove('active');
    });

    // Fechar modal ao clicar no fundo esmaecido
    overlay.addEventListener('click', () => {
      sideModal.classList.remove('active');
      overlay.classList.remove('active');
      openModalBtn.classList.remove('active');
    });

    function openModal() {
        document.getElementById("createMapModal").style.display = "flex";
    }
    
    // Fun√ß√£o para fechar a modal
    function closeModal() {
        document.getElementById("createMapModal").style.display = "none";
    }
    
    // Fechar a modal se clicar fora dela
    window.onclick = function(event) {
        if (event.target == document.getElementById("createMapModal")) {
            closeModal();
        }
    }
  </script>
    
</body>
</html>
 