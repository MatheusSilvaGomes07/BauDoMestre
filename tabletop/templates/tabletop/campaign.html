<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaign</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
    <script>
        const campaignId = {{ campaign_id }};
        const socket = new WebSocket(`ws://${window.location.host}/ws/tabletop/${campaignId}/`);
    
        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.action === 'load_map') {
                loadMap(data.map_id);
            } else if (data.action === 'move_token') {
                moveToken(data.token_id, data.position_x, data.position_y);
            }
        };
    
        function loadMap(mapId) {
            $.get(`/tabletop/map/${mapId}/`, function(data) {
                $('#map-container').html(data);
                initializeDraggableTokens();
            });
        }
    
        function selectMap(mapId) {
            socket.send(JSON.stringify({
                'action': 'load_map',
                'map_id': mapId
            }));
        }
    
        function initializeDraggableTokens() {
            $(".token").draggable({
                containment: "#map img",
                drag: function(event, ui) {
                    var tokenId = $(this).data("id");
                    var position = ui.position;
    
                    var positionX = Math.round(position.left);
                    var positionY = Math.round(position.top);
    
                    socket.send(JSON.stringify({
                        'action': 'move_token',
                        'token_id': tokenId,
                        'position_x': positionX,
                        'position_y': positionY
                    }));
                },
                stop: function(event, ui) {
                    var tokenId = $(this).data("id");
                    var position = ui.position;
    
                    var positionX = Math.round(position.left);
                    var positionY = Math.round(position.top);
    
                    $.ajax({
                        url: `/tabletop/token/${tokenId}/move/`,
                        method: 'POST',
                        data: {
                            'position_x': positionX,
                            'position_y': positionY,
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        success: function() {
                            socket.send(JSON.stringify({
                                'action': 'move_token',
                                'token_id': tokenId,
                                'position_x': positionX,
                                'position_y': positionY
                            }));
                        }
                    });
                }
            });
        }
    
        function moveToken(tokenId, positionX, positionY) {
            const token = $(`.token[data-id=${tokenId}]`);
            token.css({ left: `${positionX}px`, top: `${positionY}px` });
        }
    
        $(document).ready(function() {
            initializeDraggableTokens();
        });
    </script>
</head>
<body>
    {% if is_mestre %}

        <h1>Criar Mapa</h1>
        {% include "tabletop/includes/mapa_form.html" %}

        <h1>Criar Pasta</h1>
        {% include "tabletop/includes/pastaCriaturas.html" %}

        <h1>Campaign Maps</h1>
        {% include "tabletop/includes/lista_mapas.html" %}

    {% endif %}

    <h1> Pastas de fichas </h1>
    {% include "tabletop/includes/lista_pastasCriaturas.html" %}

    <div id="map-container">
        <!-- Loaded map will be inserted here -->
    </div>
</body>
</html>
